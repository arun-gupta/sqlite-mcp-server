name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:

  build-and-test:

    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build TypeScript
      run: |
        npm ci
        npm run build
        npm run type-check

    - name: Build the Docker image
      run: docker build . --file Dockerfile --tag arungupta/sqlite-mcp-server:$(date +%s)

    - name: Test Docker image (HTTP mode)
      run: |
        docker run -d --name test-http -p 4000:4000 -e SERVER_MODE=http -e HTTP_PORT=4000 arungupta/sqlite-mcp-server:$(date +%s)
        sleep 10
        curl -f http://localhost:4000/health || exit 1
        docker stop test-http && docker rm test-http

    - name: Test Docker image (MCP mode)
      run: |
        docker run -d --name test-mcp -e SERVER_MODE=mcp arungupta/sqlite-mcp-server:$(date +%s)
        sleep 5
        echo '{"jsonrpc":"2.0","id":1,"method":"tools/call","params":{"name":"list_tables","arguments":{}}}' | docker exec -i test-mcp node dist/server.js
        docker stop test-mcp && docker rm test-mcp
